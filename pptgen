#!/usr/bin/env bash
# PPT Generator CLI
# Cross-platform launcher for Linux and macOS

INSTALL_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Detect OS
OS="$(uname -s)"
case "${OS}" in
    Linux*)     MACHINE=Linux;;
    Darwin*)    MACHINE=Mac;;
    *)          
        echo "âŒ Error: Unsupported OS. For Windows use pptgen.bat or pptgen.ps1"
        exit 1
        ;;
esac

# Check if virtual environment exists
if [ ! -d "$INSTALL_DIR/venv" ]; then
    echo "âŒ Error: Virtual environment not found."
    echo "Please run the installation script first:"
    echo "  ./install.sh"
    exit 1
fi

cd "$INSTALL_DIR"

# Activate virtual environment
source venv/bin/activate

# Parse arguments
PRODUCTION=0
PORT=5000

while getopts "p::h" opt; do
    case $opt in
        p)
            PRODUCTION=1
            if [ ! -z "$OPTARG" ]; then
                PORT=$OPTARG
            fi
            ;;
        h)
            echo "PPT Generator CLI"
            echo ""
            echo "Usage: ./pptgen [OPTIONS]"
            echo ""
            echo "Options:"
            echo "  -p [port]    Run in production mode with Gunicorn (default port: 5000)"
            echo "  -h           Show this help message"
            echo ""
            echo "Examples:"
            echo "  ./pptgen              # Run development server"
            echo "  ./pptgen -p           # Run production server on port 5000"
            echo "  ./pptgen -p 8000      # Run production server on port 8000"
            exit 0
            ;;
        \?)
            echo "Invalid option: -$OPTARG" >&2
            exit 1
            ;;
    esac
done

# Start the server
if [ $PRODUCTION -eq 1 ]; then
    echo "ðŸš€ Starting PPT Generator in production mode on port $PORT..."
    echo "ðŸ“– Access the application at: http://localhost:$PORT"
    gunicorn -w 4 -b 0.0.0.0:$PORT main:app
else
    echo "ðŸš€ Starting PPT Generator in development mode..."
    echo "ðŸ“– Access the application at: http://localhost:5000"
    export FLASK_APP=main.py
    export FLASK_ENV=development
    python main.py
fi
